# ------------------------------------------------------------------------------
#  OpenEdge/SPARTA Test: Charged Particle Orbits in Tokamak Magnetic Field
# ------------------------------------------------------------------------------
#  Purpose:
#    Reproduce the banana and passing orbits
#
#  Description:
#    This input file initializes a 3-D domain with a single charged particle
#    (H+) moving in the analytical, axisymmetric tokamak magnetic field:
#        Bx = -B0*(2*R0*y + x*z)/(2*R^2)
#        By =  B0*(2*R0*x - y*z)/(2*R^2)
#        Bz =  B0*(R - R0)/(2*R)
#    and no electric field.
#
#    Two test cases are provided:
#       - Banana orbit  →  read_particles source_banana_orb 0
#       - Passing orbit →  read_particles source_passing_orb 0
#    Uncomment the desired case before running.
# ------------------------------------------------------------------------------

################################################################################
# --- Plasma parameters (for normalization only) -------------------------------
################################################################################
variable realDensity  equal 1e19        # [1/m^3] background plasma density
variable fnum         equal 1e15        # scaling factor for density normalization
variable T            equal 12.0*11604.505  # temperature = 12 eV (in Kelvin-equivalent)

################################################################################
# --- Simulation domain and global setup ---------------------------------------
################################################################################
seed                 1245
dimension            3
boundary             p p p              # periodic boundaries
global               gridcut 0 comm/sort no
create_box           -2 2 -2 2 -2 2
create_grid          100 100 100
balance_grid         rcb part

# normalized density and number scaling
global               nrho ${realDensity} fnum ${fnum}

################################################################################
################################################################################
# --- Impurity / test particle species -----------------------------------------
################################################################################
species              plasma.species H+
mixture              species H+ frac 1.0

################################################################################
# --- Load initial particle conditions -----------------------------------------
################################################################################
# Choose one of the two sources below:
read_particles    source_banana_orb 0   # use for banana orbit test

################################################################################
# --- Define analytical magnetic and electric fields ---------------------------
################################################################################
# Equation (32) from the paper, normalized with B0 = R0 = 1

variable B0   equal 1.0



variable R0   equal 1.0
variable eps  equal 1e-6                 # to avoid singularity at R → 0

variable xc grid 0.5*(cxlo+cxhi)
variable yc grid 0.5*(cylo+cyhi)
variable zc grid 0.5*(czlo+czhi)
variable R  grid sqrt(v_xc*v_xc+v_yc*v_yc+v_eps*v_eps)


# variable define a sinuosoid #sinusoid: S(t) = 1 + a · sin(2π f t + φ0)
variable A   equal 0.001
variable phi0 equal 0
variable f equal 50
variable S_t equal v_A*sin(PI*time*v_f)

# Magnetic field components (axisymmetric tokamak)
variable Bx grid "-v_B0*(2.0*v_R0*v_yc + v_xc*v_zc)/(2.0*v_R*v_R)*v_S_t"
variable By grid "v_B0*(2.0*v_R0*v_xc- v_yc*v_zc)/(2.0*v_R*v_R)*v_S_t"
variable Bz grid "v_B0*(v_R-v_R0)/(2.0*v_R)*v_S_t"

# Register field fixes and make them global
fix       2 bfield/grid Bx By Bz
global    bfield grid 2 1


################################################################################
# --- Field application and integration settings -------------------------------
################################################################################
variable dt         equal 0.314          # normalized timestep = π/10
variable numStep    equal 50 #floor(8.14E3)  # total steps (≈8×10^5)
variable dumpFreq1  equal 1 #floor(${numStep}/1000)


fix     fixID ave/grid all 1 50 50  f_2[*] ave running
dump    dumpID  grid all ${numStep} tmp.forces id xc yc zc f_fixID[*]


################################################################################
# --- Diagnostics and execution ------------------------------------------------
################################################################################
dump      10 particle all ${dumpFreq1} state id type x y z vx vy vz
timestep  ${dt}
#stats     ${dumpFreq1}
#stats_style step cpu np

run       ${numStep}

# ------------------------------------------------------------------------------
#  End of file
# ------------------------------------------------------------------------------


