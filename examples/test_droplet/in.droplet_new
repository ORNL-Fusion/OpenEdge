# Copyright 2024, OpenEdge contributors
# Authors: Abdou Diaw
# License: GPL-2.0 license
# This script simulate lithium (Li) droplet dynamics in a uniform plasma environment using CAT.
# Setup: 2D domain with magnetic field equilibrium and plasma at sound speed along magnetic field lines.


############################################------simulation domain setup-------#####################################
seed                12345
dimension           2
boundary            r r p
global              gridcut 0.0 comm/sort no
create_box          2. 6 -4. 3.8 -0.05 0.05

create_grid         1000 1000 1
balance_grid        rcb  cell

############################################------species in the plasma (current and future)-------#####################################
species droplet.species mist Li Li+ Li2+ Li3+

mixture             LigamentSource  mist        frac 1.0 nrho 1 

global fnum 1e12
mixture             LiSource  Li        frac 1.0
mixture             LiSource  Li+       frac 0.0
mixture             LiSource  Li2+      frac 0.0
mixture             LiSource  Li3+      frac 0.0

############################################------set properties of wall: material and interaction-------#####################################
#global target_material Li mass 7.0 charge 3.0 binding_energy 1.64

read_surf          wall.surf group surfID particle check
surf_collide       wallColModel vanish
surf_modify        all collide wallColModel

read_surf          core.surf invert group surfID2 particle check
surf_modify        surfID2 collide wallColModel

variable pmass  particle mass

group            divertor_outer surf id 40 #<> 37 50
group            divertor_inner surf id <> 10 17

# emit a droplet at given surface and angle and velocity
fix              droplet_emission emit/droplet LigamentSource divertor_outer normal no n 1 perspecies no magVelocity 10 incidentAngle 45
#dump S particle all 1 source  id type x y z vx vy vz
read_particles source 1
run 1
#exit
unfix droplet_emission
# compute evap



variable dt   equal 1e-08
variable time equal 2.5e-3
variable N equal floor(${time}/${dt})
variable N1 equal floor($N/100)



# compute evap
fix 22 evap 1 LigamentSource mass mass radius radius temp temp heatflux/file heatflux.h5 # heatflux/constant 50e6


# Emit one droplet

# fix emit Li atoms given evaporation
#fix emit/evap/Li


dump 10 particle all ${N1} LigamentSource_w_g  id type x y z vx vy vz v_pmass temp radius


variable npart equal np
fix 31 halt ${N1} v_npart <= 0

# Forces Gravity
variable g equal -9.8
variable gradBx grid "v_g"
fix BY field/grid NULL gradBx NULL
global   field grid BY 1


compute cnear plasma/fields/file all surfID plasma.h5 bfield.h5 mindist surfid bx by bz temp_e dens_e temp_i dens_i parrflow ex ey ez nesheath grad_te_r grad_te_t grad_te_z grad_ti_r grad_ti_t grad_ti_z

fix BC viscous 1 2.0 1 plasma c_cnear[5] c_cnear[6] c_cnear[9] c_cnear[10] bfield c_cnear[3] c_cnear[4] c_cnear[5]


timestep ${dt}
stats 1000
stats_style step cpu np

run 1 #$N
